<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>CloudPivot</title>
    <link rel="stylesheet" type="text/css" href="./pivot.css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link href="bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="bootstrap.min.js"></script>

    <script src="./logicblox.js"></script>
    <script>
        // OPTIONS
        var BLOX_WEB_URL = location.href.match(/lennart.c9.io/) 
            ? "https://lennart.c9.io"
            : "https://lbdemo.c9.io";
        var WORKSPACE = "measure-samples1";
        var USERNAME = "user1";
        var PASSWORD = "password";
        var INITIAL_QUERY = {
            horizontal: ["Location:store"],
            vertical: ["Calendar:month","Calendar:week"], 
            values: ["Sales"],
            workspace: WORKSPACE,
            servicesuffix: "_" // big data set: "_100"
        };

        // Architect Boot Loader
        var packages = [
            "lib/architect/architect"
        ];

        require(packages, function (architect) {
            require("ace/config").set("packaged", true);
            require.plugins.shift();
            require.plugins.push({
                consumes : [],
                provides : ["http", "c9", "vfs"],
                setup    : function(options, imports, register){
                    register(null, {
                        http: { ajax: function(){} },
                        c9: { on: function(){}  },
                        vfs: { vfs: function(){}  }
                    });
                }
            });
            
            var i = require.plugins.indexOf("plugins/c9.fs/vfs");
            require.plugins.splice(i, 1);
            
            architect.resolveConfig(require.plugins, function (err, config) {
                if (err) throw err;
                
                config.forEach(function(p) {
                    if (p.provides.indexOf("pivot") >= 0) {
                        p.initialQuery = INITIAL_QUERY;
                    }
                    if (p.provides.indexOf("logicblox") >= 0 && /c9.dev/.test(window.location.href))
                        p.enableLogging = false;
                });
                
                var app = architect.createApp(config, function(err, app) {
                    if (err) throw err;

                    app.on("error", function(name) {
                          throw name;
                    });
                    app.on("service", function(name) {
                        console.log("Loaded " + name);
                    });

                    app.getService("logicblox").connect({
                        bloxWebURL: BLOX_WEB_URL,
                        workspace: WORKSPACE,
                        username: USERNAME,
                        password: PASSWORD,
                        skipCheck: true,
                        useNew: true
                    }, function(err) {
                        var pivot = app.getService("pivot");
                        app.pivotTable = pivot.draw();
                    });
                    
                    window.app = app;
                });
                app.on("service", function(name, service) {
                    if (typeof service != "function")
                        service.name = name;
                    console.log("Loaded " + name);
                });
            });
        });
    </script>
</body>
</html>
