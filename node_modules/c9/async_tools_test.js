"use strict";

var sinon = require("sinon");
var async_tools = require("./async_tools");

module.exports = {
    
    "test callback should be called max every 2sec": function() {
        var clock = sinon.useFakeTimers();
        
        var cb = sinon.stub();
        var throttle = async_tools.throttle(2000, cb);
        
        sinon.assert.callCount(cb, 0);
        
        throttle();
        sinon.assert.callCount(cb, 1);
        
        throttle();
        sinon.assert.callCount(cb, 1);
        
        clock.tick(1000);
        throttle();
        sinon.assert.callCount(cb, 1);
        
        clock.tick(999);
        throttle();
        sinon.assert.callCount(cb, 1);
        
        clock.tick(2);
        throttle();
        sinon.assert.callCount(cb, 2);
        
        clock.tick(2000);
        throttle();
        sinon.assert.callCount(cb, 3);
        
        clock.restore();
    },
    
    "test once should be called exactly once": function() {
        var cb = sinon.stub();
        
        var o = async_tools.once(cb);
        
        o(1, 2, 3);
        sinon.assert.callCount(cb, 1);
        sinon.assert.calledWith(cb, 1, 2, 3);
        
        o();
        sinon.assert.callCount(cb, 1);
        
        o();
        sinon.assert.callCount(cb, 1);
    }
    
};

!module.parent && require("asyncjs").test.testcase(module.exports).exec();