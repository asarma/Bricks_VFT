var fs = require("fs");
var tmp = require("tmp");
var async = require("async");

exports.writeFile = function(path, data, options, callback) {
    if (typeof options == "function")
        return exports.writeFile(path, data, null, options);
    
    async.waterfall([
        tmp.file.bind(null, options || {}),
        function(tmpFile, fd, next) {
            fs.close(fd, function(err) {
                next(err, tmpFile);
            });
        },
        function(tmpFile, next) {
            fs.writeFile(tmpFile, data, options, function(err) {
                next(err, tmpFile);
            });
        },
        function(tmpFile, next) {
            fs.rename(tmpFile, path, next);
        }
    ], callback);
};