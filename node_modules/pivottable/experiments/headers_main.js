define(function(require, exports, module) {
"use strict";

var HeaderModel = require("./headers/header_model").HeaderModel;
var DragHeaders = require("./headers/drag_headers").DragHeaders;
var JsonDataProvider = require("./json.file");
var Pivot = require("pivot/pivot"); 

function main() {
    console.log("main");
    
    var div = document.getElementById("grid");
    
    var pivot = new Pivot(div, 90, 24);
    pivot.setOption("totals", true);
    
    var providerJson = new JsonDataProvider();
    providerJson.loadFromUrl("summary.json", function(){
        providerJson.setQuery(
          ["product"],
          ["person"], 
          {kind: "sum", entity: "value"},
          true,
        function(){ 
            pivot.setDataProvider(providerJson);
            
            providerJson.entities["product"].axis = "y";
            providerJson.entities["person"].axis = "x";
            
            var headers = new HeaderModel(providerJson.entities);
            
            headers.on("change", function(e){
                providerJson.setQuery(
                  headers.axis.x.map(function(n){ return n.name }),
                  headers.axis.y.map(function(n){ return n.name }), 
                  {kind: "sum", entity: "value"},
                  true,
                function(){ 
                    pivot.setDataProvider(providerJson);
                });
            });
            
            new DragHeaders(
                "none",
                document.getElementById("list"),
                headers
            );
            new DragHeaders(
                "x",
                document.getElementById("hor_headings"),
                headers
            );
            new DragHeaders(
                "y",
                document.getElementById("ver_headings"),
                headers
            );
        });
    });
    
    window.addEventListener("resize", function(){
        pivot.resize();
    })
}

main();

});